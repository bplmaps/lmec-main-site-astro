---
import { useStoryblokApi } from "@storyblok/astro";

const storyblokApi = useStoryblokApi()

const { data } = await storyblokApi.get('cdn/stories', {
  version: import.meta.env.DEV ? 'draft' : 'published',
  starts_with: 'main-site/',
  resolve_links: 'url',
  content_type: 'event-page',
  sort_by: 'content.eventDate:desc',
  per_page: 1,
})
let events = data.stories
events = Object.values(events)
events = events.map((event: any) => {
  return {
    params: {
      name: event.name,
      slug: event.slug,
      eventDate: event.content.eventDate,
    },
  }
})

const upcomingEvents = events.filter((event: any) => {
  return new Date(event.params.eventDate) >= new Date()
})
---

{upcomingEvents.length > 0 &&
  <li class="mb-3">
    <span class="badge bg-light font-secondary whats-new-badge me-1">Next event</span>
    {upcomingEvents.map((event: any) => (
      <a href={`/event/${event.params.slug}`}>{event.params.name}</a>
      <span class="text-secondary">
        {new Date(event.params.eventDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric'})}
      </span>
    ))} Â· <a href="/event/">More events</a>
  </li>
}
