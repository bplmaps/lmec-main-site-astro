---
import { getPath } from '../../../lib/utils';
import Layout from '../../../layouts/Layout.astro';
import { useStoryblokApi } from "@storyblok/astro";
import Sidebar from '../../../components/Layout/Sidebar.astro';
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import type { ISbResult } from '@storyblok/astro';

const storyblokApi = useStoryblokApi()
 
const pageData: ISbResult = await await storyblokApi.get(
  `cdn/stories/main-site/about/people`,
  {
    version: String(import.meta.env.STORYBLOK_IS_PREVIEW) == 'true' ? 'draft' : 'published',
  }
)
 
const page = (pageData.data as any).story;
const path = getPath(page.full_slug);

let allPeople = [];

let currentPage = 1;
const perPage = 100;

while (true) {
  const { data } = await storyblokApi.get('cdn/stories', {
    version: String(import.meta.env.STORYBLOK_IS_PREVIEW) == 'true' ? 'draft' : 'published',
    starts_with: 'main-site/about/people',
    content_type: 'staff-page',
    per_page: perPage,
    page: currentPage,
  })
  let people = data.stories
  people = Object.values(people)

  if (people.length === 0) {
    break; // Exit the loop if no stories are returned (i.e., last page)
  }

  allPeople.push(...people);
  currentPage++;
}

allPeople = allPeople.map((person: any) => {
  return {
    params: {
      slug: person.slug,
      staffName: person.content.staffName,
      title: person.content.title,
      headshot: person.content.headshot,
    },
  }
})
---

<Layout title={`${page.name}`} subheading={`${page.content.page_description ? page.content.page_description : ''}`} image={`${page.content.header_img && page.content.header_img.filename}`}>
  <section class="section-sm">
    <div class="row">
      <div class="col-lg-8 order-1 order-lg-1">
        <div class="row">
          {allPeople &&
            <div class="col-12 mb-4 content">
              <h2>Staff</h2>
              <div class="row">
                {allPeople.map((person: any) => (
                  <div class="staff-list-card col-sm-12 col-md-4">
                    {person.params.headshot &&
                      <a href={`/about/people/${person.params.slug}`}>
                        <img src={person.params.headshot.filename} alt={`Headshot of ${person.params.staffName}`} class="card-img-top staff-headshot-circle" />
                      </a>
                    }
                    {person.params.slug &&
                      <h5>
                        <a href={`/about/people/${person.params.slug}`}>{person.params.staffName}</a>
                      </h5>
                    }
                    {person.params.title &&
                      <p>
                        <em>{person.params.title}</em>
                      </p>
                    }
                  </div>
                ))}
              </div>
            </div>
          }
          <div class="col-12 mb-5 content">
            <StoryblokComponent name={page.name} blok={page.content} />
          </div>
        </div>
      </div>
      
      <aside class="col-lg-4 order-2 order-lg-2 section-sidebar">
        <Sidebar path={path} />
      </aside>
    </div>
  </section>
</Layout>
