---
import Layout from '../../../layouts/Layout.astro';
import Card from "../../../components/Article/Card.astro";
import Pagination from "../../../components/Pagination.astro";
import { fetchTagsWithSlugs, fetchStoriesByTag, fetchStoriesPaginated } from "../../../lib/storyblok-fetch";
import type { GetStaticPathsOptions } from 'astro';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const tags = await fetchTagsWithSlugs({ starts_with: 'main-site/' });

  const paths = await Promise.all(
    tags.map(async (tag: any) => {
      const allStories = await fetchStoriesByTag(tag.name);

      return paginate(allStories, {
        params: { slug: tag.slug },
        pageSize: 10,
      });
    })
  );

  return paths.flat();
}

const { page } = Astro.props;
const { slug } = Astro.params;

const pageParam = Astro.params.page;
const currentPage = pageParam ? parseInt(pageParam) : 1;

const tags = await fetchTagsWithSlugs({ starts_with: 'main-site/' });
const tag = tags.find((x: any) => x.slug === slug);

let stories;
let totalPages;
const storiesPerPage = 10;

if (page) {
  // Static generation mode - use paginated data
  stories = page.data;
  totalPages = page.lastPage;
} else {
  // SSR mode - fetch data dynamically
  const { stories: fetchedStories, total } = await fetchStoriesPaginated({
    page: currentPage,
    per_page: storiesPerPage,
    with_tag: tag.name,
    starts_with: 'main-site/',
  });

  stories = fetchedStories;
  totalPages = Math.ceil(total / storiesPerPage);
}

stories = stories.map((story: any) => {
  return {
    params: {
      title: story.name,
      description: story.content.description,
      slug: story.slug,
      headerImage: story.content.headerImage,
      eventDate: story.content.eventDate,
      publishedAt: story.content.publishDate,
      author: story.content.author,
      contentType: story.content.component,
    },
  };
});
---

<Layout title={tag.name} description="We use maps, geography, and history to explore the connections between places and people in Boston, New England, and beyond. Our collection of a quarter million goegraphic objects, our educational programs, and free exhibitions bring the power of historical geography to everyone.">
  <section class="section">
    <div class="row">
      {stories.map((story: any) => (
        <article class="col-sm-6 mb-5">
          {story.params.contentType === 'event-page' &&
            <Card href={`/event/${story.params.slug}`} thumbnail={story.params.headerImage} title={story.params.title} date={story.params.eventDate} />
          }
          {story.params.contentType === 'article-page' &&
            <Card href={`/articles/${story.params.slug}`} thumbnail={story.params.headerImage} title={story.params.title} description={story.params.description} date={story.params.publishedAt} author={story.params.author} />
          }
        </article>
      ))}
      <div class="col-12 mt-4">
        <Pagination urlBase={`/tags/${tag.slug}`} maxPagesToShow={5} currentPage={currentPage} totalPages={totalPages} />
      </div>
    </div>
  </section>
</Layout>
