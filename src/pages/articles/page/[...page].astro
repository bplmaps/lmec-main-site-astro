---
import Layout from '../../../layouts/Layout.astro';
import { createSlug } from '../../../lib/utils';
import Card from "../../../components/Article/Card.astro";
import Pagination from "../../../components/Pagination.astro";
import { fetchArticles, fetchTopTags, fetchStoriesPaginated } from "../../../lib/storyblok-fetch";
import type { GetStaticPathsOptions } from 'astro';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const allArticles = await fetchArticles();

  const mappedArticles = allArticles.map((article: any) => {
    return {
      params: {
        title: article.name,
        description: article.content.description,
        slug: article.slug,
        headerImage: article.content.headerImage,
        publishedAt: article.content.publishDate,
        author: article.content.author,
        contentType: article.content.component,
      },
    };
  });

  return paginate(mappedArticles, {
    pageSize: 10
  });
}

const { page } = Astro.props;

const pageParam = Astro.params.page;
const currentPage = pageParam ? parseInt(pageParam) : 1;

if (isNaN(currentPage) || currentPage < 1) {
  return Astro.redirect('/articles');
}

let tags = [];
let articles = [];
let totalPages = 0;

const articlesPerPage = 10;

const mapArticle = (article: any) => ({
  params: {
    title: article.name,
    description: article.content.description,
    slug: article.slug,
    headerImage: article.content.headerImage,
    publishedAt: article.content.publishDate,
    author: article.content.author,
    contentType: article.content.component,
  },
});

try {
  tags = await fetchTopTags(20);

  if (page) {
    // Static generation mode - use pre-generated paginated data
    articles = page.data;
    totalPages = page.lastPage;
  } else {
    // SSR mode - fetch data dynamically for the current page
    const { stories, total } = await fetchStoriesPaginated({
      page: currentPage,
      per_page: articlesPerPage,
      starts_with: 'main-site/',
      content_type: 'article-page',
      sort_by: 'sort_by_date:desc:nulls_last',
    });

    articles = stories.map(mapArticle);
    totalPages = Math.ceil(total / articlesPerPage) || 0;
  }

  if (currentPage > totalPages && totalPages > 0) {
    return Astro.redirect('/articles');
  }
} catch (error) {
  console.error('Error fetching articles:', error);
  return Astro.redirect('/articles');
}
---

<Layout title="Articles" description="Articles and posts that explore and explain our collections and initiatives" subheading="Articles and posts that explore and explain our collections and initiatives" pill="Article">
  <section class="section">
    <div class="row">
      <div class="col-12 order-2 order-lg-1">
        <div class="row">
          <h3>Filter articles by tag</h3>
          <div class="tagcloud">
            {tags.map((tag: any) => (
              <span class="badge rounded-pill bg-light text-secondary mb-1 tagcloud-item">
                <a href={`/tags/${createSlug(tag.name)}`}>{tag.name}</a>
                <span class="badge bg-info" >{tag.taggings_count}</span>
              </span>
            ))}
          </div>
        </div>
        <hr>
        <div class="row">
          {articles.map((article: any) => (
            <article class="col-sm-6 mb-5">
              <Card href={`/articles/${article.params.slug}`} thumbnail={article.params.headerImage} title={article.params.title} description={article.params.description} date={article.params.publishedAt} author={article.params.author} />
            </article>
          ))}
          <div class="col-12 mt-4">
            <Pagination urlBase="/articles/page" maxPagesToShow={5} currentPage={currentPage} totalPages={totalPages} />
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
