---
import Layout from '../../layouts/Layout.astro';
import { useStoryblokApi } from "@storyblok/astro";
import Card from '../../components/Event/Card.astro';

const storyblokApi = useStoryblokApi()
let allEvents = [];

let page = 1;
const perPage = 100;

while (true) {
  const { data } = await storyblokApi.get('cdn/stories', {
    version: String(import.meta.env.STORYBLOK_IS_PREVIEW) == 'true' ? 'draft' : 'published',
    starts_with: 'main-site/',
    content_type: 'event-page',
    per_page: perPage,
    page: page,
  })
  let events = data.stories
  events = Object.values(events)

  if (events.length === 0) {
    break; // Exit the loop if no stories are returned (i.e., last page)
  }

  allEvents.push(...events);
  page++;
}

allEvents = allEvents.map((event: any) => {
  return {
    params: {
      name: event.name,
      slug: event.slug,
      headerImage: event.content.headerImage,
      eventDate: event.content.eventDate,
      tags: event.content.tags,
    },
  }
})

const upcomingEvents = allEvents.filter((event: any) => {
  return new Date(event.params.eventDate) >= new Date()
})

const pastEvents = allEvents.filter((event: any) => {
  return new Date(event.params.eventDate) < new Date()
})
---

<Layout title="Upcoming Events" description="We use maps, geography, and history to explore the connections between places and people in Boston, New England, and beyond. Our collection of a quarter million goegraphic objects, our educational programs, and free exhibitions bring the power of historical geography to everyone.">
  {upcomingEvents &&
    <section class="section">
      <div class="row">
        {upcomingEvents.map((event: any) => (
          <div class="col-lg-4 col-sm-6 mb-4">
            <Card href={`/event/${event.params.slug}`} thumbnail={event.params.headerImage} name={event.params.name} date={event.params.eventDate} tags={event.params.tags} />
          </div>
        ))}
      </div>
    </section>
  }
  
  {pastEvents &&
    <section class="section pt-0">
      <div class="row mb-3">
        <div class="col-12">
          <h2>Past Events</h2>
        </div>
      </div>
      <div class="row">
        {pastEvents.map((event: any) => (
          <div class="col-lg-3 col-sm-4 mb-2">
            <Card href={`/event/${event.params.slug}`} thumbnail={event.params.headerImage} name={event.params.name} date={event.params.eventDate} tags={event.params.tags} />
          </div>
        ))}
      </div>
    </section>
  }
</Layout>
